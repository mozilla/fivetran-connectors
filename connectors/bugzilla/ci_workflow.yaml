build-job-bugzilla:
  docker:
    - image: python:3.8
  steps:
    - checkout
    - compare-branch:
        pattern: ^connectors/bugzilla/
    - run:
        name: Build
        command: |
          python3.8 -m venv venv/
          venv/bin/pip install -r requirements.txt
          cd connectors/bugzilla
          venv/bin/pip install -r requirements.txt
    - run:
        name: isort
        command: venv/bin/isort --check .
    - run:
        name: Mypy
        command: venv/bin/mypy --ignore-missing-imports .
    - run:
        name: Test connector code
        command: venv/bin/pytest --black --flake8 tests/
deploy-bugzilla:
  docker:
    - image: google/cloud-sdk
  steps:
    - checkout
    - run:
        name: Authorize gcloud CLI
        command: |
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/gcp.json"
          echo "$GCLOUD_SERVICE_KEY" > "$GOOGLE_APPLICATION_CREDENTIALS"
          gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          gcloud config set project $GCLOUD_PROJECT
    - run:
        name: Deploy Function
        command: |
          cd connectors/bugzilla
          gcloud functions deploy bugzilla --entry-point main --runtime python38 --trigger-http --service-account $GCLOUD_FUNCTION_ACCOUNT
