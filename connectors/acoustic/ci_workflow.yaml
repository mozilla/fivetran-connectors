build-job-acoustic-connector:
  docker:
    - image: python:3.8
  steps:
    - checkout
    - compare-branch:
        pattern: ^connectors/accoustic/
    - run:
        name: Build
        command: |
          python3.8 -m venv venv/
          venv/bin/pip install -r requirements.txt
          venv/bin/pip install -r connectors/acoustic/requirements.txt
    - run:
        name: isort
        command: venv/bin/isort --check connectors/acoustic/
    - run:
        name: Mypy
        command: venv/bin/mypy --ignore-missing-imports connectors/acoustic/
    - run:
        name: Test connector code
        command: venv/bin/pytest --black --flake8 connectors/acoustic/tests/
deploy-acoustic:
  docker:
    - image: google/cloud-sdk
  steps:
    - checkout
    - run:
        name: Authorize gcloud CLI
        command: |
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/gcp.json"
          echo "$GCLOUD_SERVICE_KEY" > "$GOOGLE_APPLICATION_CREDENTIALS"
          gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          gcloud config set project $GCLOUD_PROJECT
    - run:
        name: Deploy Function
        command: |
          cd connectors/acoustic
          gcloud functions deploy acoustic --entry-point main --runtime python38 --trigger-http --service-account $GCLOUD_FUNCTION_ACCOUNT
